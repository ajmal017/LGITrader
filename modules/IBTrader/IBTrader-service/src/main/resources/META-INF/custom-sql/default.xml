<?xml version="1.0" encoding="UTF-8"?>
<custom-sql>
	<sql id="com.ibtrader.data.service.persistence.RealtimeFinder.findLastRealTimeLessThanDate">
    <![CDATA[ 
        SELECT 
        		*
        FROM 
        		IBTrader_Realtime      
        WHERE            
            (IBTrader_Realtime.shareId=?)
            AND (IBTrader_Realtime.companyid=?)
            AND (IBTrader_Realtime.groupid=?)
         	AND (IBTrader_Realtime.createDate)=  (SELECT  max(IBTrader_Realtime.createDate) FROM 
					         			IBTrader_Realtime       
					      	  		WHERE            
					           			 (IBTrader_Realtime.shareId=?)
					          		  AND (IBTrader_Realtime.companyid=?)
					          		  AND (IBTrader_Realtime.groupid=?)
					          		  AND (IBTrader_Realtime.createDate<?))
     ]]>
    </sql>
    <sql id="com.ibtrader.data.service.persistence.RealtimeFinder.findMinMaxRealTime">
    <![CDATA[ 
        SELECT 
        		min(value) as min_value , max(value) as max_value 
        FROM 
        		IBTrader_Realtime      
        WHERE
            (IBTrader_Realtime.createDate>=?) AND
            (IBTrader_Realtime.createDate<?) AND
            (IBTrader_Realtime.shareId=?)
            AND (IBTrader_Realtime.companyid=?)
            AND (IBTrader_Realtime.groupid=?)
     ]]>
    </sql>
     <sql id="com.ibtrader.data.service.persistence.RealtimeFinder.findLastRealTime">
    <![CDATA[ 
        SELECT 
        		*
        FROM 
        		IBTrader_Realtime      
        WHERE            
            (IBTrader_Realtime.shareId=?)
            AND (IBTrader_Realtime.companyid=?)
            AND (IBTrader_Realtime.groupid=?)
         	AND (IBTrader_Realtime.createDate)=  (SELECT  max(IBTrader_Realtime.createDate) FROM 
					         			IBTrader_Realtime      
					      	  		WHERE            
					           			 (IBTrader_Realtime.shareId=?)
					          		  AND (IBTrader_Realtime.companyid=?)
					          		  AND (IBTrader_Realtime.groupid=?))
            
            
     ]]>
    </sql>
    <!-- 
    avg(value) value : media movil
    count(*) : periodos encontrados
     -->
     <sql id="com.ibtrader.data.service.persistence.RealtimeFinder.findSimpleMobileAvgGroupByPeriods">
    <![CDATA[ 
    	SELECT 
    		 IFNULL(avg(IBTrader_Realtime.value),0) as value, COUNT(distinct treal.createdate)  as periodsfound 
    	FROM (
	    	SELECT 
	    		 max(T.createDate) as createDate, barDate,T.shareId,T.companyId,T.groupId
	    	FROM (
	        	SELECT 
	        		IBTrader_Realtime.createDate, DATE_FORMAT(IBTrader_Realtime.createDate, '%Y-%m-%d %H:%i') as barDate, 
	        		IBTrader_Realtime.shareId,IBTrader_Realtime.companyId,IBTrader_Realtime.groupId         
	        	FROM 
	        		IBTrader_Realtime      
	        	WHERE            
		        	(IBTrader_Realtime.createDate>=?) AND (IBTrader_Realtime.createDate<?) 
		        	AND (IBTrader_Realtime.shareId=?)
	            	AND (IBTrader_Realtime.companyid=?)
	            	AND (IBTrader_Realtime.groupid=?)         	
	         		AND  DATE_FORMAT(createDate, '%Y-%m-%d %H:%i') in ([$TIMEBAR_DATES$])
		        ORDER  BY 	
	        	 	IBTrader_Realtime.createdate
	        	 ) as  T
	       	GROUP BY 
				barDate,
				T.shareid,
				T.companyId,
				T.groupId             
            ) as  treal, IBTrader_Realtime 
		WHERE
		 	treal.createDate= IBTrader_Realtime.createDate
	        and  treal.shareId= IBTrader_Realtime.shareid
	        and  treal.companyId= IBTrader_Realtime.companyId
	        and  treal.groupId= IBTrader_Realtime.groupId
	          
	          
 
     ]]>
    </sql>
    
     <sql id="com.ibtrader.data.service.persistence.PositionFinder.getPositionClosedResults">
    <![CDATA[
    
			    SELECT  
						count(*) OPERACIONES, (sum(beneficio*acciones) / SUM(PRECIOENTRADA*acciones)*100)  MARGENBENEFICIO, 
						 sum(beneficio*acciones) BENEFICIO,sum(PRECIOENTRADA*acciones) INVERTIDO, TIPO
				FROM
				(	SELECT case type_
							 when 'BUY' then price_real_out - price_real_in
							 when 'SELL' then price_real_in - price_real_out
					       END BENEFICIO,
					       share_number acciones,
					       type_ tipo,
					       price_real_in PRECIOENTRADA
					FROM IBTrader_Position
					WHERE
						(IBTrader_Position.date_real_in>=?) AND (IBTrader_Position.date_real_in<?)
						AND  (IBTrader_Position.date_real_out IS NOT NULL)
						AND (IBTrader_Position.companyid=?)
	            		AND (IBTrader_Position.groupid=?)         	
				)	 rt 
				GROUP BY tipo
	 
     ]]>
    </sql>
    
    
</custom-sql>