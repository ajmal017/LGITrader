<?xml version="1.0" encoding="UTF-8"?>
<custom-sql>
	<sql id="com.ibtrader.data.service.persistence.RealtimeFinder.findLastRealTimeLessThanDate">
    <![CDATA[ 
        SELECT 
        		*
        FROM 
        		IBTrader_Realtime      
        WHERE            
            (IBTrader_Realtime.shareId=?)
            AND (IBTrader_Realtime.companyid=?)
            AND (IBTrader_Realtime.groupid=?)
         	AND (IBTrader_Realtime.createDate)=  (SELECT  max(IBTrader_Realtime.createDate) FROM 
					         			IBTrader_Realtime       
					      	  		WHERE            
					           			 (IBTrader_Realtime.shareId=?)
					          		  AND (IBTrader_Realtime.companyid=?)
					          		  AND (IBTrader_Realtime.groupid=?)
					          		  AND (IBTrader_Realtime.createDate<?))
     ]]>
    </sql>
    <sql id="com.ibtrader.data.service.persistence.RealtimeFinder.findMinMaxRealTime">
    <![CDATA[ 
        SELECT 
        		min(value) as min_value , max(value) as max_value 
        FROM 
        		IBTrader_Realtime      
        WHERE
            (IBTrader_Realtime.createDate>=?) AND
            (IBTrader_Realtime.createDate<?) AND
            (IBTrader_Realtime.shareId=?)
            AND (IBTrader_Realtime.companyid=?)
            AND (IBTrader_Realtime.groupid=?)
     ]]>
    </sql>
     <sql id="com.ibtrader.data.service.persistence.RealtimeFinder.findLastRealTime">
    <![CDATA[ 
        SELECT 
        		*
        FROM 
        		IBTrader_Realtime      
        WHERE            
            (IBTrader_Realtime.shareId=?)
            AND (IBTrader_Realtime.companyid=?)
            AND (IBTrader_Realtime.groupid=?)
         	AND (IBTrader_Realtime.createDate)=  (SELECT  max(IBTrader_Realtime.createDate) FROM 
					         			IBTrader_Realtime      
					      	  		WHERE            
					           			 (IBTrader_Realtime.shareId=?)
					          		  AND (IBTrader_Realtime.companyid=?)
					          		  AND (IBTrader_Realtime.groupid=?))
            
            
     ]]>
    </sql>
    <!-- 
    avg(value) value : media movil
    count(*) : periodos encontrados
     -->
     <sql id="com.ibtrader.data.service.persistence.RealtimeFinder.findSimpleMobileAvgGroupByPeriods">
    <![CDATA[ 
    	SELECT 
    		 IFNULL(avg(IBTrader_Realtime.value),0) as value, COUNT(distinct treal.createdate)  as periodsfound 
    	FROM (
	    	SELECT 
	    		 max(T.createDate) as createDate, barDate,T.shareId,T.companyId,T.groupId
	    	FROM (
	        	SELECT 
	        		IBTrader_Realtime.createDate, DATE_FORMAT(IBTrader_Realtime.createDate, '%Y-%m-%d %H:%i') as barDate, 
	        		IBTrader_Realtime.shareId,IBTrader_Realtime.companyId,IBTrader_Realtime.groupId         
	        	FROM 
	        		IBTrader_Realtime      
	        	WHERE            
		        	(IBTrader_Realtime.createDate>=?) AND (IBTrader_Realtime.createDate<?) 
		        	AND (IBTrader_Realtime.shareId=?)
	            	AND (IBTrader_Realtime.companyid=?)
	            	AND (IBTrader_Realtime.groupid=?)         	
	         		AND  DATE_FORMAT(createDate, '%Y-%m-%d %H:%i') in ([$TIMEBAR_DATES$])
		        ORDER  BY 	
	        	 	IBTrader_Realtime.createdate
	        	 ) as  T
	       	GROUP BY 
				barDate,
				T.shareid,
				T.companyId,
				T.groupId             
            ) as  treal, IBTrader_Realtime 
		WHERE
		 	treal.createDate= IBTrader_Realtime.createDate
	        and  treal.shareId= IBTrader_Realtime.shareid
	        and  treal.companyId= IBTrader_Realtime.companyId
	        and  treal.groupId= IBTrader_Realtime.groupId
	          
	          
 
     ]]>
    </sql>
    
    <!--  como las posiciones puieden estar abiertas, cogemos el realtime en su caso o el precio de cierre  
    incluimos el multiplicador del activo para los futuros o 1 para el resto -->
     <sql id="com.ibtrader.data.service.persistence.PositionFinder.getPositionOpenResults">
    <![CDATA[
    
			    SELECT  
						(sum(beneficio*acciones*multiplier) / SUM(PRECIOENTRADA*multiplier*acciones)*100)  MARGENBENEFICIO, 
						 sum(beneficio*acciones*multiplier) BENEFICIO
				FROM
				(	SELECT case type_
						   WHEN 'BUY' then IF(price_real_out>0,price_real_out,REALTIME.value) - price_real_in
						   WHEN 'SELL' then price_real_in - IF(price_real_out>0,price_real_out,REALTIME.value)
					       END BENEFICIO,
					       share_number acciones,
					       type_ tipo,
					       price_real_in PRECIOENTRADA,
					       SHARE.multiplier
					FROM IBTrader_Position, IBTrader_Realtime REALTIME,IBTrader_share SHARE
					WHERE
						(
							(IBTrader_Position.date_real_out>=?)
							OR
							(IBTrader_Position.date_real_out) IS NULL
						)						
						AND (IBTrader_Position.companyid=?)
	            		AND (IBTrader_Position.groupid=?)
	            		AND	 (REALTIME.shareId=IBTrader_Position.shareId)
						AND	 (REALTIME.companyid=IBTrader_Position.companyid)
						AND	 (REALTIME.groupid=IBTrader_Position.groupid)
						AND	 (REALTIME.shareId=SHARE.shareId)
						AND	 (REALTIME.companyid=SHARE.companyid)
						AND	 (REALTIME.groupid=SHARE.groupid)
	           		    AND (REALTIME.createDate)=  (SELECT  max(IBTrader_Realtime.createDate) FROM 
					         			IBTrader_Realtime      
					      	  		WHERE            
					           			 (IBTrader_Realtime.shareId=IBTrader_Position.shareId)
					          		  AND (IBTrader_Realtime.companyid=IBTrader_Position.companyid)
					          		  AND (IBTrader_Realtime.groupid=IBTrader_Position.groupid))    
				)	 rt 
				
	 
     ]]>
    </sql>
    
     <!--  
    incluimos el multiplicador del activo para los futuros o 1 para el resto -->
     <sql id="com.ibtrader.data.service.persistence.PositionFinder.getPositionClosedResults">
    <![CDATA[
    
			    SELECT  
						count(*) OPERACIONES, (sum(beneficio*acciones*multiplier) / SUM(PRECIOENTRADA*acciones*multiplier)*100)  MARGENBENEFICIO, 
						 sum(beneficio*acciones*multiplier) BENEFICIO,sum(PRECIOENTRADA*acciones*multiplier) INVERTIDO, TIPO
				FROM
				(	SELECT case type_
							 when 'BUY' then price_real_out - price_real_in
							 when 'SELL' then price_real_in - price_real_out
					       END BENEFICIO,
					       share_number acciones,
					       type_ tipo,
					       price_real_in PRECIOENTRADA,
					       SHARE.multiplier
					FROM IBTrader_Position,IBTrader_share SHARE
					WHERE
						(IBTrader_Position.date_real_in>=?) AND (IBTrader_Position.date_real_in<?)
						AND  (IBTrader_Position.date_real_out IS NOT NULL)
						AND (IBTrader_Position.companyid=?)
	            		AND (IBTrader_Position.groupid=?)        
	            		AND	 (IBTrader_Position.shareId=SHARE.shareId) 	
				)	 rt 
				GROUP BY tipo
	 
     ]]>
    </sql>
    
    
    <!--  POSICIONES ABIERTAS SIN CERRAR O OPERACIONES DEL DIA -->
     <sql id="com.ibtrader.data.service.persistence.PositionFinder.getIntradiaPositions">
    <![CDATA[
    				SELECT 	
    					IBTrader_Position.*
					FROM 
						IBTrader_Position
					WHERE
						(
							(IBTrader_Position.date_real_out>=?)
							OR
							(IBTrader_Position.date_real_out) IS NULL
						)						
						AND (IBTrader_Position.companyid=?)
	            		AND (IBTrader_Position.groupid=?)         	
				
					ORDER BY date_real_in DESC
	 
     ]]>
    </sql>
    
    
</custom-sql>